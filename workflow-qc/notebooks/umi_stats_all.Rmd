---
title: "Quality control report (all)"
format: html
---

```{r library, include=FALSE}
library(dplyr)
library(ggplot2)
library(purrr)
library(readr)
library(scales)
library(stringr)
```

```{r constants, include=FALSE}
umi_breaks <- 10^(-1:10)
umi_minor_breaks <- rep(c(1, 2, 5), 12) * (10^rep(-1:10, each = 3))
barcode_breaks <- 10^(-1:10)
barcode_minor_breaks <- 10^rep(-1:10)
```

```{r snakemake, include=FALSE}
umi_stats_files <- snakemake@input[["umi_stats"]]
experiment_title <- snakemake@params[["title"]]
umi_min <- snakemake@params[["umi_min"]]
genes_min <- snakemake@params[["genes_min"]]
mt_max <- snakemake@params[["mt_max"]]
sample_ids <- basename(str_remove(umi_stats_files, ".tsv.gz"))
```

## Information

- **Experiment:** `r experiment_title`
- **Minimum UMI sum:** `r umi_min`
- **Minimum genes detected:** `r genes_min`
- **Maximum mitochondrial content:** `r paste0(mt_max * 100, "%")`

```{r raw_qc_data, include=FALSE}
raw_qc_data <- purrr::map_dfr(
  umi_stats_files,
   readr::read_tsv,
    show_col_types = FALSE
  ) |> 
  mutate(
    Sample = factor(Sample, levels = sample_ids),
    cellranger_filtered = factor(cellranger_filtered, levels = c(TRUE, FALSE), labels = c("cell", "empty"))
  )
raw_qc_data
```

```{r umi_ranks, include=FALSE}
raw_qc_data <- raw_qc_data |> 
  dplyr::group_by(Sample) |> 
  dplyr::arrange(desc(umi_sum)) |>
  dplyr::mutate(umi_sum_rank = row_number()) |>
  dplyr::arrange(desc(genes_detected)) |> 
  dplyr::mutate(genes_detected_rank = row_number()) |> 
  dplyr::ungroup()
```

## Ranking barcodes by total UMI

```{r plot_umi_rank, fig.width=12, fig.height=5, echo=FALSE}
raw_qc_data |> 
  filter(umi_sum > 10) |> 
  distinct(Sample, umi_sum, .keep_all = TRUE) |> 
  ggplot(aes(umi_sum_rank, umi_sum, colour = Sample)) +
  geom_line() +
  geom_hline(
    yintercept = umi_min,
    linetype = "dashed",
    linewidth = 0.1,
    colour = "red"
    ) +
  facet_wrap(
    vars(cellranger_filtered),
    ncol = 2,
    labeller = label_both
  ) +
  scale_x_log10(
    breaks = barcode_breaks,
    minor_breaks = umi_minor_breaks,
    labels = scales::label_number(scale_cut = scales::cut_short_scale()),
    limits = c(1, NA)
  ) +
  scale_y_log10(
    breaks = barcode_breaks,
    minor_breaks = umi_minor_breaks,
    labels = scales::label_number(scale_cut = scales::cut_short_scale()),
    limits = c(1, NA)
  ) +
  guides(
    colour = guide_legend(override.aes = list(linewidth = 3))
  ) +
  labs(
    title = experiment_title,
    x = "Rank (by UMI sum)",
    y = "UMI sum"
  ) +
  theme_bw()
```

Notes:

-  Only droplet with more than 10 UMI are shown.

## Ranking barcodes by number of genes detected

```{r plot_genes_detected_rank, fig.width=12, fig.height=5, echo=FALSE}
raw_qc_data |> 
  filter(umi_sum > 10) |> 
  distinct(Sample, genes_detected, .keep_all = TRUE) |> 
  ggplot(aes(genes_detected_rank, genes_detected, colour = Sample)) +
  geom_line() +
  geom_hline(
    yintercept = genes_min,
    linetype = "dashed",
    linewidth = 0.1,
    colour = "red"
    ) +
  facet_wrap(
    vars(cellranger_filtered),
    ncol = 2,
    labeller = label_both
  ) +
  scale_x_log10(
    breaks = barcode_breaks,
    minor_breaks = umi_minor_breaks,
    labels = scales::label_number(scale_cut = scales::cut_short_scale()),
    limits = c(1, NA)
  ) +
  scale_y_log10(
    breaks = barcode_breaks,
    minor_breaks = umi_minor_breaks,
    labels = scales::label_number(scale_cut = scales::cut_short_scale()),
    limits = c(1, NA)
  ) +
  guides(
    colour = guide_legend(override.aes = list(linewidth = 3))
  ) +
  labs(
    title = experiment_title,
    x = "Rank (by gene)",
    y = "Genes detected"
  ) +
  theme_bw()
```

Notes:

-  Only droplet with more than 10 UMI are shown.

## Mitochondrial content

```{r plot_mt_pct_rank, fig.width=12, fig.height=5, echo=FALSE}
raw_qc_data |> 
  filter(umi_sum > 100) |> 
  ggplot(aes(Sample, mt_pct, colour = cellranger_filtered)) +
  geom_violin(scale = "width") +
  geom_hline(
    yintercept = mt_max,
    linetype = "dashed",
    linewidth = 0.1,
    colour = "red"
    ) +
  scale_y_continuous(
    breaks = seq(0, 1, by = 0.1),
    limits = c(0, 1),
    labels = label_percent()
  ) +
  labs(
    title = experiment_title,
    x = "Sample",
    y = "Mitochondrial content"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

Notes:

-  Only droplet with UMI sum over 100 are shown.

## Statistics after filtering

```{r}
raw_qc_data |> 
  filter(
    cellranger_filtered == "cell" &
    umi_sum >= umi_min &
    genes_detected >= genes_min &
    mt_pct <= mt_max
  ) |> 
  summarise(
    cells_pass = n(),
    .by = Sample
  )
```

